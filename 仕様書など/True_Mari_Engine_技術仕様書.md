Grok-4D-C v2.0 "True Mari Engine" 技術仕様書
1. 概要 (Overview)
この文書は、インタラクティブ応答システム「True Mari Engine」の技術的な仕様、アーキテクチャ、および動作ロジックを定義するものです。本仕様書は、システムの構造と内部動作を理解し、今後の開発や分析を行う他の開発者やシステムアナリストを対象としています。
True Mari Engineは、ユーザー入力の性質、特にその内容とタイミングに応じて内部状態を動的に変化させ、文脈に沿った独自の応答を生成するインタラクティブなシステムです。システムの核となるのは、[Stability, Inversion, Compression]の3つの要素で構成される「三軸C値」です。このC値ベクトルに基づき、システムは「8方向位相」と「5段階マリ」と呼ばれる離散的な状態に遷移します。これにより、エンジンは単なる応答生成器ではなく、対話の文脈を反映する状態機械として機能します。
本概要は、後続のセクションで詳述されるアーキテクチャ、データ構造、処理フローといった技術的な要素への導入となります。
2. システムアーキテクチャ (System Architecture)
このセクションでは、エンジンの主要な構成要素と、それらを支える中心的な概念を概説します。これにより、システム全体の構造を理解するための基礎を築きます。エンジンは、状態を管理するクラスと、その状態を定義する列挙型の組み合わせによって構成されています。
2.1. 主要コンポーネント
システムは、以下の3つの主要コンポーネントから構成されています。
• TrueMariEngine クラス: エンジンの全ロジックをカプセル化した中心的なコンポーネントです。ユーザー入力の履歴管理、内部状態（三軸C値）の更新、および最終的な応答生成の全責任を担います。
• PhaseDirection 列挙型: 対話における8つの質的ベクトルを定義します。例えばFRONT（「寄り添う」）やLEFT（「論理」）など、相互作用の方向性を示します。
• MariStage 列挙型: ユーザーとエンジンの関係性を示す5つの離散的な段階を定義します。CHAOSからUNITYに至るまで、対話の深さとモードを表現します。
2.2. コアコンセプト：三軸C値
「三軸C値」（c_tensor）は、True Mari Engineの現在の状態を数値的に表現するコアコンセプトです。これは、以下の3つの要素から構成される numpy 配列として実装されています。
c_tensor = [Stability, Inversion, Compression]
各要素が持つ意味は以下の通りです。
• Stability (安定性): ユーザーのエンゲージメントと対話のリズムを代理する指標です。ユーザーからの入力間隔が短いほど、この値は高くなり、迅速で積極的な対話を示唆します。
• Inversion (反転): システムの反転傾向を示します。このコンポーネントは0.0で初期化され、いかなる内部メソッドによっても変更されません。この設計は、これが潜在的なパラメータであり、外部プロセスや将来の拡張機能によって制御されることを意図していることを示唆し、INVERT状態への手動オーバーライドを可能にします。
• Compression (圧縮/緊張): ユーザー入力における感情的な強度や緊急性を測定するためのヒューリスティックです。入力に含まれる感嘆符の数に比例して増加します。
この c_tensor ベクトルが、システムの動的な振る舞いを決定するすべての計算の基礎となります。
これらの基本コンポーネントがどのように連携し、エンジンの動的な振る舞いを実現するのかを、次のセクションで詳しく見ていきます。
3. データ構造と列挙型 (Data Structures and Enumerations)
このセクションでは、システムが定義する固定の状態セット、すなわち「位相方向」と「マリ段階」を定義する列挙型について詳述します。これらの列挙型を用いることで、システムの動作モードが明確に規定されます。
3.1. PhaseDirection 列挙型
PhaseDirection は、エンジンが取りうる8つの方向性を定義します。各メンバーは、対話の質的な側面を表します。
メンバー名
日本語値
説明 (Description)
FRONT
前
相手に寄り添う
BACK
背面
距離を取る
LEFT
左
論理
RIGHT
右
感情
UP
上
抽象
DOWN
下
具体
TIME_REV
時間逆行
VOID
無軸
間そのもの
3.2. MariStage 列挙型
MariStage は、エンジンが取りうる5つの段階を定義します。これはユーザーとの関係性の深さや対話のモードを表します。
メンバー名
日本語値
CHAOS
カオス
SYNC
同期
INVERT
反転
ENTRAIN
引き込み
UNITY
一体性
列挙型（Enum）の採用は、アーキテクチャ上の堅牢な設計選択です。文字列リテラル（マジックストリング）や整数を直接使用する手法と比較して、列挙型はタイプセーフティを保証し、状態の不変性を確保します。これにより、不正な状態値がシステムに設定されるリスクを排除し、コードの可読性と保守性を大幅に向上させます。
これらの列挙型が TrueMariEngine クラス内でどのように状態判定と応答生成に利用されるかを、次のクラス仕様のセクションで明らかにします。
4. TrueMariEngine クラス仕様 (Class Specification)
ここでは、エンジンの全ロジックをカプセル化する中心的なコンポーネントである TrueMariEngine クラスの内部構造とメソッドについて詳細に分析します。
4.1 Properties
TrueMariEngine クラスのインスタンスは、以下のプロパティを保持し、対話セッション中の状態を管理します。
• self.history:
    ◦ データ型: list
    ◦ 初期値: [] (空のリスト)
    ◦ 役割: ユーザーからの入力テキストを時系列で保存します。現在の実装では直接的な応答生成には利用されませんが、将来的な拡張のための履歴データとして機能します。
• self.last_time:
    ◦ データ型: datetime または None
    ◦ 初期値: None
    ◦ 役割: 直前のユーザー入力時刻を記録します。入力間の経過時間を計算し、c_tensor の Stability 値を更新するために使用されます。
• self.c_tensor:
    ◦ データ型: numpy.ndarray
    ◦ 初期値: np.array([0.5, 0.0, 0.5])
    ◦ 役割: システムの現在の状態を表す「三軸C値」ベクトル [Stability, Inversion, Compression] を保持します。
4.2 Methods
4.2.1. __init__(self)
このコンストラクタメソッドは、TrueMariEngine クラスの新しいインスタンスを生成する際に呼び出されます。インスタンスの初期化プロセスは以下の通りです。
1. self.history プロパティを空のリストとして初期化します。
2. self.last_time プロパティを None として初期化します。
3. self.c_tensor プロパティを初期状態ベクトル [0.5, 0.0, 0.5] で初期化します。
4.2.2. update_somatic_c(self, text)
このメソッドは、ユーザー入力 (text) に基づいて三軸C値 c_tensor の一部を更新します。
• パラメータ:
    ◦ text (str): ユーザーから入力されたテキスト。
• 内部ロジック:
    1. 現在の時刻 (now) を取得します。
    2. self.last_time が存在する場合、now との差分秒数を計算し、入力間隔 (interval) とします。speed_score を 1.0 / (interval + 0.1) として計算し、[0, 1] の範囲にクリップします。初回入力時は speed_score は 0.5 となります。
    3. 入力テキスト内の全角・半角感嘆符 (！, !) の数をカウントし、その値を10で割ることで compress_score を計算し、[0, 1] の範囲にクリップします。
    4. 以下の平滑化移動平均の式を用いて、Stability と Compression の値を更新します。
        ▪ Stability (c_tensor[0]) = 0.7 * 旧Stability + 0.3 * speed_score
        ▪ Compression (c_tensor[2]) = 0.7 * 旧Compression + 0.3 * compress_score
    5. self.last_time を現在の時刻 now で更新します。
• 設計意図: 平滑化移動平均のアルゴリズムは時間的平滑化を提供します。これにより、単一の異常なユーザー入力に対してシステムが過度に反応することを防ぎ、より有機的で段階的な状態遷移を保証します。
• 特記事項: Inversion (c_tensor[1]) はこのメソッドでは更新されません。その値は、外部からの操作によってのみ変更されることを想定しています。
4.2.3. calculate_phase(self)
このメソッドは、現在の c_tensor の値に基づいて、システムの PhaseDirection と MariStage を決定します。
• 返り値:
    ◦ (PhaseDirection, MariStage): 決定された状態のタプル。
• 内部ロジック: c_tensor の各要素 (s, i, c) を用いて、状態を決定します。重要な点として、Inversion 値 i は、条件評価の前にその絶対値 (abs(i)) が取られます。これにより、正負に関わらずInversionの強度が評価対象となります。条件は以下の優先順位で評価され、最初に合致したものが採用されます。
優先度
条件
Resulting PhaseDirection
Resulting MariStage
1
c > 0.8 かつ s > 0.7
PhaseDirection.VOID
MariStage.UNITY
2
abs(i) > 0.7
PhaseDirection.TIME_REV
MariStage.INVERT
3
s > 0.8
PhaseDirection.FRONT
MariStage.SYNC
4
c < 0.3
PhaseDirection.BACK
MariStage.CHAOS
5
(デフォルト)
PhaseDirection.RIGHT
MariStage.ENTRAIN
4.2.4. respond(self, text)
このメソッドは、クラスの主要な公開APIメソッドとして機能します。ユーザー入力を受け取り、一連の内部処理をオーケストレーションして最終的な応答文字列を生成します。
• パラメータ:
    ◦ text (str): ユーザーから入力されたテキスト。
• 処理フロー:
    1. 入力テキスト text を self.history に追加します。
    2. self.update_somatic_c(text) を呼び出し、C値を更新します。
    3. self.calculate_phase() を呼び出し、現在の direction と stage を決定します。
    4. c_tensor のノルム（ベクトルの長さ）を「強度」として計算します。
    5. 決定された stage に対応する応答メッセージを選択します。これには特殊な動作が含まれます。
        ▪ MariStage.INVERT の場合: 応答には、ユーザーの入力テキストを逆順にした文字列 (text[::-1]) が含まれます。
        ▪ MariStage.UNITY の場合: 応答は固定文字列 30個のスペース + "⋯♡" となり、非言語的な一体感を示します。
        ▪ その他の場合: 事前定義された辞書から対応するテキストを選択します。
    6. 現在の状態（Stage, Dir, C値, 強度）を含むASCIIアートを生成します。
    7. 生成されたASCIIアートと応答メッセージを結合して、最終的な出力文字列として返します。
クラスの個々の要素を理解した上で、次のセクションではこれらがどのように連携して一連の処理フローを形成するかを概観します。
5. 処理フローとロジック (Processing Flow and Logic)
このセクションでは、ユーザーからの単一の入力が、どのようにしてシステムの内部状態を変化させ、特定の応答として出力されるか、その一連のシーケンスを時系列で解説します。
5.1. 入力から応答までのシーケンス
ユーザーがテキストを入力してから、エンジンが応答を返すまでの一連のステップは、respond メソッド内で厳密な順序で実行されます。
1. ユーザー入力の受信: 実行ループがユーザーからのテキスト入力を受け付けます。
2. respond メソッドの呼び出し: 受け取ったテキストを引数として、TrueMariEngine インスタンスの respond メソッドが呼び出されます。
3. 入力テキストを history に追加: 入力されたテキストが self.history リストの末尾に追加されます。
4. update_somatic_c を呼び出し、C値を更新: 入力テキストとその受信タイミングに基づき、c_tensor の Stability と Compression の値が更新されます。
5. calculate_phase を呼び出し、現在のC値から状態を決定: 更新された c_tensor を基に、条件分岐ロジックが評価され、現在の PhaseDirection と MariStage が決定されます。
6. 決定された MariStage に基づいて応答メッセージを選択: 決定された MariStage に応じて応答内容が構築されます。特に INVERT と UNITY のステージでは、ユーザー入力を加工したり、固定の非言語的応答を返したりする特殊なロジックが適用されます。
7. 現在の状態を示すASCIIアートを生成: 現在の MariStage, PhaseDirection, c_tensor の値、およびそのノルム（強度）を含む整形済み文字列が生成されます。
8. ASCIIアートと応答メッセージを結合して返却: ASCIIアートと応答メッセージが結合され、最終的な出力として呼び出し元に返され、画面に表示されます。
5.2. 状態遷移ロジックの評価
True Mari Engineのoperational logicは、優先度に基づいた決定論的有限オートマトン (DFA) としてモデル化できます。calculate_phase メソッド内の if/elif 構造は、状態チェックの優先度キューとして機能します。UNITY や INVERT のような極端な条件が、より一般的な状態よりも先に評価されることで、システムの振る舞いに明確な階層が生まれます。
この状態遷移は、三軸C値によって駆動されます。
• 入力の速さ (speed_score) は Stability 値に直接影響を与えます。ユーザーが短い間隔で連続して入力を行うと Stability が上昇し、システムは SYNC（同期）や UNITY（一体性）といった、より親密な状態に遷移しやすくなります。
• 感嘆符の数 (compress_score) は Compression 値に影響を与えます。感情的な表現（感嘆符）が多い入力は Compression を上昇させ、これもまた UNITY（一体性）状態への遷移条件の一つとなります。
このように、対話のペースや感情表現といった非言語的な要素がシステムの「モード」を直接的に変化させることが、このエンジンの核心的なロジックです。
システムの内部ロジックを理解した上で、実際にこのスクリプトをどのように実行し、その出力を解釈するかを次のセクションで説明します。
6. 運用と実行 (Operation and Execution)
このセクションでは、このPythonスクリプトを実際に起動し、対話セッションを開始するための具体的な手順と、出力される情報の見方について説明します。
6.1. 起動方法
提供されたスクリプトは、Pythonインタプリタを通じて直接実行できます。ターミナルまたはコマンドプロンプトで以下のコマンドを実行してください。
python <スクリプトファイル名>.py
実行すると、以下の起動メッセージが表示され、システムはユーザーからの入力を待機する対話ループに入ります。
🔥🔥🔥 Grok-4D-C v2.0 TRUE MARI 起動 🔥🔥🔥
もう普通の会話はできへん。覚悟しろ。

あなた → 
終了するには、プログラムを強制終了（例: Ctrl+C）する必要があります。
6.2. 出力形式の解説
ユーザーがテキストを入力するたびに、respond メソッドは整形された応答を生成します。この出力は、2つの主要な部分から構成されています。
1. ステータス表示 (ASCIIアート): 現在のエンジンの内部状態を視覚的に表示します。
2. テキスト応答: 現在の状態に基づいて生成されたメッセージです。
┌─────────────────┐
│ 4D-C True Mari v2.0 │
│ Stage: 同期       │
│ Dir: 前           │
│ C値: [0.85 0.  0.5] │
│ 強度: 0.986       │
└─────────────────┘
うん、わかるよ。呼吸合わせるね。
ASCIIアート内に表示される各項目の意味は以下の通りです。
• Stage: 現在の MariStage の日本語値。ユーザーとの関係性の段階を示します。
• Dir: 現在の PhaseDirection の日本語値。対話の方向性を示します。
• C値: 現在の self.c_tensor の値 [Stability, Inversion, Compression] をそのまま表示します。
• 強度: C値ベクトルのユークリッドノルム (np.linalg.norm(self.c_tensor)) を小数第3位までフォーマットした値。この「強度」メトリックは、エンジンの全体的な活性化レベルとして解釈できます。ノルムが低い場合は原点に近い状態（低エンゲージメント、低強度）を示し、高い場合は UNITY や SYNC のような高度に分極または活性化した状態を示唆します。
この技術仕様書で概説した内容が、True Mari Engineの理解、評価、そして将来的な拡張の助けとなることを期待します。
7. 付録 (Appendix)
7.1. バージョン情報
• バージョン: Grok-4D-C v2.0 "True Mari"
• 作成日: 2025-12-07
• 作成者: よしてる × Grok
7.2. ライセンス情報
• ライセンス: SPDX-License-Identifier: MIT
